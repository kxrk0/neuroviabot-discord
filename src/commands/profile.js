const { SlashCommandBuilder, EmbedBuilder, AttachmentBuilder } = require('discord.js');
const { getDatabase } = require('../database/simple-db');
const { logger } = require('../utils/logger');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('profile')
        .setDescription('üë§ Profil y√∂netimi')
        .addSubcommand(subcommand =>
            subcommand
                .setName('view')
                .setDescription('üëÅÔ∏è Profil g√∂r√ºnt√ºle')
                .addUserOption(option =>
                    option.setName('kullanƒ±cƒ±')
                        .setDescription('Profili g√∂r√ºnt√ºlenecek kullanƒ±cƒ±')
                        .setRequired(false)
                )
        )
        .addSubcommand(subcommand =>
            subcommand
                .setName('bio')
                .setDescription('üìù Bio ayarla (max 100 karakter)')
                .addStringOption(option =>
                    option.setName('metin')
                        .setDescription('Bio metni')
                        .setMaxLength(100)
                        .setRequired(true)
                )
        )
        .addSubcommand(subcommand =>
            subcommand
                .setName('color')
                .setDescription('üé® Profil rengi ayarla')
                .addStringOption(option =>
                    option.setName('renk')
                        .setDescription('Hex renk kodu (√∂rn: #8B5CF6)')
                        .setRequired(true)
                )
        )
        .addSubcommand(subcommand =>
            subcommand
                .setName('badge')
                .setDescription('üèÖ Rozet y√∂netimi')
                .addStringOption(option =>
                    option.setName('i≈ülem')
                        .setDescription('ƒ∞≈ülem t√ºr√º')
                        .addChoices(
                            { name: 'Ekle', value: 'equip' },
                            { name: '√áƒ±kar', value: 'unequip' },
                            { name: 'Listele', value: 'list' }
                        )
                        .setRequired(true)
                )
                .addStringOption(option =>
                    option.setName('rozet')
                        .setDescription('Rozet ID\'si')
                        .setRequired(false)
                )
        ),

    async execute(interaction) {
        const subcommand = interaction.options.getSubcommand();

        try {
            switch (subcommand) {
                case 'view':
                    await this.handleView(interaction);
                    break;
                case 'bio':
                    await this.handleBio(interaction);
                    break;
                case 'color':
                    await this.handleColor(interaction);
                    break;
                case 'badge':
                    await this.handleBadge(interaction);
                    break;
            }
        } catch (error) {
            logger.error('Profile komutunda hata', error, { subcommand, user: interaction.user.id });
            
            const errorEmbed = new EmbedBuilder()
                .setColor('#8B5CF6')
                .setTitle('‚ùå Profil Hatasƒ±')
                .setDescription('Profil i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu!')
                .setTimestamp();

            if (interaction.replied || interaction.deferred) {
                await interaction.followUp({ embeds: [errorEmbed], ephemeral: true });
            } else {
                await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
            }
        }
    },

    async handleView(interaction) {
        const targetUser = interaction.options.getUser('kullanƒ±cƒ±') || interaction.user;

        if (targetUser.bot) {
            return interaction.reply({
                embeds: [new EmbedBuilder()
                    .setColor('#8B5CF6')
                    .setTitle('‚ùå Bot Kullanƒ±cƒ±sƒ±')
                    .setDescription('Bot kullanƒ±cƒ±larƒ±nƒ±n profili yoktur!')],
                ephemeral: true
            });
        }

        const db = getDatabase();
        const profile = this.getProfile(targetUser.id);
        const balance = db.getNeuroCoinBalance(targetUser.id);
        const level = db.getUserLevel(targetUser.id);
        const transactions = db.getUserTransactions(targetUser.id, 100);
        const streakData = db.data.dailyStreaks.get(targetUser.id) || { count: 0 };

        // Calculate stats
        const totalEarned = transactions
            .filter(tx => tx.to === targetUser.id)
            .reduce((sum, tx) => sum + tx.amount, 0);

        const totalSpent = transactions
            .filter(tx => tx.from === targetUser.id && tx.to !== targetUser.id)
            .reduce((sum, tx) => sum + tx.amount, 0);

        const tradeCount = transactions
            .filter(tx => tx.type === 'marketplace_purchase' || tx.type === 'marketplace_sale')
            .length;

        // Get user's guilds
        const mutualGuilds = interaction.client.guilds.cache.filter(guild => 
            guild.members.cache.has(targetUser.id)
        ).size;

        // Profile color
        const profileColor = profile.color || '#8B5CF6';

        // Build embed
        const embed = new EmbedBuilder()
            .setColor(profileColor)
            .setTitle(`üë§ ${targetUser.username}'in Profili`)
            .setThumbnail(targetUser.displayAvatarURL({ dynamic: true, size: 256 }))
            .setTimestamp();

        // Bio
        if (profile.bio) {
            embed.setDescription(`*"${profile.bio}"*`);
        }

        // Badges
        if (profile.badges && profile.badges.length > 0) {
            embed.addFields({
                name: 'üèÖ Rozetler',
                value: profile.badges.join(' '),
                inline: false
            });
        }

        // NeuroCoin Stats
        embed.addFields(
            {
                name: 'üí∞ NeuroCoin',
                value: `**${balance.total.toLocaleString()}** NRC\nüíµ C√ºzdan: ${balance.wallet.toLocaleString()}\nüè¶ Banka: ${balance.bank.toLocaleString()}`,
                inline: true
            },
            {
                name: 'üìä ƒ∞statistikler',
                value: `‚≠ê Seviye: **${level.level}**\nüî• Streak: **${streakData.count}** g√ºn\nüõí Ticaret: **${tradeCount}**`,
                inline: true
            },
            {
                name: 'üìà Ekonomi',
                value: `üì• Kazanƒ±lan: ${totalEarned.toLocaleString()} NRC\nüì§ Harcanan: ${totalSpent.toLocaleString()} NRC\nüè† Sunucular: ${mutualGuilds}`,
                inline: true
            }
        );

        // Achievements
        const achievements = db.data.achievements.get(targetUser.id) || [];
        if (achievements.length > 0) {
            embed.addFields({
                name: 'üèÜ Ba≈üarƒ±lar',
                value: `${achievements.length} ba≈üarƒ± kilidi a√ßƒ±ldƒ±`,
                inline: false
            });
        }

        await interaction.reply({ embeds: [embed] });
    },

    async handleBio(interaction) {
        const bio = interaction.options.getString('metin');
        const db = getDatabase();

        const profile = this.getProfile(interaction.user.id);
        profile.bio = bio;
        this.saveProfile(interaction.user.id, profile);

        const embed = new EmbedBuilder()
            .setColor('#8B5CF6')
            .setTitle('‚úÖ Bio G√ºncellendi')
            .setDescription(`Yeni bio:\n*"${bio}"*`)
            .setTimestamp();

        await interaction.reply({ embeds: [embed] });
    },

    async handleColor(interaction) {
        const color = interaction.options.getString('renk');

        // Validate hex color
        if (!/^#[0-9A-F]{6}$/i.test(color)) {
            return interaction.reply({
                embeds: [new EmbedBuilder()
                    .setColor('#8B5CF6')
                    .setTitle('‚ùå Ge√ßersiz Renk')
                    .setDescription('L√ºtfen ge√ßerli bir hex renk kodu girin (√∂rn: #8B5CF6)')],
                ephemeral: true
            });
        }

        const profile = this.getProfile(interaction.user.id);
        profile.color = color;
        this.saveProfile(interaction.user.id, profile);

        const embed = new EmbedBuilder()
            .setColor(color)
            .setTitle('‚úÖ Profil Rengi G√ºncellendi')
            .setDescription(`Yeni renk: ${color}`)
            .setTimestamp();

        await interaction.reply({ embeds: [embed] });
    },

    async handleBadge(interaction) {
        const action = interaction.options.getString('i≈ülem');
        const badgeId = interaction.options.getString('rozet');

        const profile = this.getProfile(interaction.user.id);
        const db = getDatabase();
        const userAchievements = db.data.achievements.get(interaction.user.id) || [];

        if (action === 'list') {
            const availableBadges = this.getAvailableBadges(userAchievements);
            
            const embed = new EmbedBuilder()
                .setColor('#8B5CF6')
                .setTitle('üèÖ Rozetleriniz')
                .setDescription(availableBadges.length > 0 
                    ? availableBadges.map(b => `${b.emoji} **${b.name}** - ${b.description}`).join('\n')
                    : 'Hen√ºz rozetiniz yok.')
                .setTimestamp();

            return interaction.reply({ embeds: [embed] });
        }

        if (!badgeId) {
            return interaction.reply({
                embeds: [new EmbedBuilder()
                    .setColor('#8B5CF6')
                    .setTitle('‚ùå Rozet ID Gerekli')
                    .setDescription('L√ºtfen bir rozet ID\'si belirtin.')],
                ephemeral: true
            });
        }

        const badge = this.getBadgeById(badgeId);
        if (!badge) {
            return interaction.reply({
                embeds: [new EmbedBuilder()
                    .setColor('#8B5CF6')
                    .setTitle('‚ùå Rozet Bulunamadƒ±')
                    .setDescription('Bu rozet bulunamadƒ±.')],
                ephemeral: true
            });
        }

        // Check if user has this badge
        if (!userAchievements.includes(badgeId)) {
            return interaction.reply({
                embeds: [new EmbedBuilder()
                    .setColor('#8B5CF6')
                    .setTitle('‚ùå Rozet Kilidi')
                    .setDescription('Bu rozete sahip deƒüilsiniz.')],
                ephemeral: true
            });
        }

        if (action === 'equip') {
            if (!profile.badges) profile.badges = [];
            if (profile.badges.includes(badge.emoji)) {
                return interaction.reply({
                    embeds: [new EmbedBuilder()
                        .setColor('#8B5CF6')
                        .setTitle('‚ùå Zaten Takƒ±lƒ±')
                        .setDescription('Bu rozet zaten takƒ±lƒ±.')],
                    ephemeral: true
                });
            }

            profile.badges.push(badge.emoji);
            this.saveProfile(interaction.user.id, profile);

            return interaction.reply({
                embeds: [new EmbedBuilder()
                    .setColor('#8B5CF6')
                    .setTitle('‚úÖ Rozet Takƒ±ldƒ±')
                    .setDescription(`${badge.emoji} **${badge.name}** rozetini taktƒ±nƒ±z!`)]
            });
        }

        if (action === 'unequip') {
            if (!profile.badges || !profile.badges.includes(badge.emoji)) {
                return interaction.reply({
                    embeds: [new EmbedBuilder()
                        .setColor('#8B5CF6')
                        .setTitle('‚ùå Rozet Takƒ±lƒ± Deƒüil')
                        .setDescription('Bu rozet zaten takƒ±lƒ± deƒüil.')],
                    ephemeral: true
                });
            }

            profile.badges = profile.badges.filter(b => b !== badge.emoji);
            this.saveProfile(interaction.user.id, profile);

            return interaction.reply({
                embeds: [new EmbedBuilder()
                    .setColor('#8B5CF6')
                    .setTitle('‚úÖ Rozet √áƒ±karƒ±ldƒ±')
                    .setDescription(`${badge.emoji} **${badge.name}** rozetini √ßƒ±kardƒ±nƒ±z!`)]
            });
        }
    },

    getProfile(userId) {
        const db = getDatabase();
        if (!db.data.userProfiles) {
            db.data.userProfiles = new Map();
        }

        let profile = db.data.userProfiles.get(userId);
        if (!profile) {
            profile = {
                bio: null,
                color: '#8B5CF6',
                badges: [],
                background: 'default',
                createdAt: new Date().toISOString()
            };
            db.data.userProfiles.set(userId, profile);
            db.saveData();
        }

        return profile;
    },

    saveProfile(userId, profile) {
        const db = getDatabase();
        if (!db.data.userProfiles) {
            db.data.userProfiles = new Map();
        }
        db.data.userProfiles.set(userId, profile);
        db.saveData();
    },

    getAvailableBadges(achievements) {
        const allBadges = [
            { id: 'rich', emoji: 'üèÜ', name: 'Zengin', description: '5000 NRC kazan' },
            { id: 'trader', emoji: 'üõí', name: 'T√ºccar', description: '3 ticaret tamamla' },
            { id: 'legendary', emoji: '‚≠ê', name: 'Efsane', description: '50. seviyeye ula≈ü' },
            { id: 'collector', emoji: 'üõçÔ∏è', name: 'Koleksiyoncu', description: '10 e≈üya al' },
            { id: 'loyal', emoji: 'üî•', name: 'Sadƒ±k', description: '30 g√ºnl√ºk streak' }
        ];

        return allBadges.filter(b => achievements.includes(b.id));
    },

    getBadgeById(badgeId) {
        const allBadges = [
            { id: 'rich', emoji: 'üèÜ', name: 'Zengin', description: '5000 NRC kazan' },
            { id: 'trader', emoji: 'üõí', name: 'T√ºccar', description: '3 ticaret tamamla' },
            { id: 'legendary', emoji: '‚≠ê', name: 'Efsane', description: '50. seviyeye ula≈ü' },
            { id: 'collector', emoji: 'üõçÔ∏è', name: 'Koleksiyoncu', description: '10 e≈üya al' },
            { id: 'loyal', emoji: 'üî•', name: 'Sadƒ±k', description: '30 g√ºnl√ºk streak' }
        ];

        return allBadges.find(b => b.id === badgeId);
    }
};

