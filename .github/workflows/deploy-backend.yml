name: âš™ï¸ Deploy Backend API to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy Backend API
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
          
      - name: ğŸš€ Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_BACKEND_PATH }}
        run: |
          # Backend klasÃ¶rÃ¼nÃ¼ VPS'e gÃ¶nder
          echo "ğŸ“¤ Uploading backend to VPS..."
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude 'node_modules' \
            --exclude '.env' \
            ./backend/ \
            $VPS_USER@$VPS_HOST:$VPS_PATH/
          
          # VPS'te deployment iÅŸlemleri
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            
            echo "ğŸ”„ Starting backend deployment..."
            
            cd ${{ secrets.VPS_BACKEND_PATH }}
            
            # Node modules temizle ve yeniden yÃ¼kle
            echo "ğŸ§¹ Cleaning node_modules..."
            rm -rf node_modules
            rm -f package-lock.json
            
            echo "ğŸ“¦ Installing dependencies..."
            npm install --production
            
            # .env dosyasÄ±nÄ± oluÅŸtur
            cat > .env << EOF
          PORT=5000
          NODE_ENV=production
          DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
          DISCORD_CLIENT_SECRET=${{ secrets.DISCORD_CLIENT_SECRET }}
          DISCORD_REDIRECT_URI=https://neuroviabot.xyz/api/auth/callback
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          BOT_TOKEN=${{ secrets.DISCORD_TOKEN }}
          DATABASE_URL=../data/database.json
          CORS_ORIGIN=https://neuroviabot.xyz
          EOF
            
            # PM2 ile backend'i yeniden baÅŸlat
            echo "ğŸ”„ Restarting backend with PM2..."
            
            pm2 delete neuroviabot-backend 2>/dev/null || true
            
            pm2 start index.js --name neuroviabot-backend \
              --max-memory-restart 400M \
              --time \
              --log-date-format "YYYY-MM-DD HH:mm:ss" \
              --merge-logs
            
            pm2 save
            
            echo "âœ… Backend deployment completed!"
            pm2 status neuroviabot-backend
          ENDSSH
          
      - name: âœ… Deployment Success
        if: success()
        run: |
          echo "ğŸ‰ Backend API successfully deployed!"
          echo "âš™ï¸ Backend is now running!"
          
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "ğŸ’¥ Backend deployment failed!"
          exit 1
