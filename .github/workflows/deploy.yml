name: ğŸš€ Deploy NeuroViaBot to VPS

# Bu iÅŸ akÄ±ÅŸÄ± ne zaman Ã§alÄ±ÅŸacak?
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    # Bu iÅŸlerin Ã§alÄ±ÅŸacaÄŸÄ± sanal makine
    runs-on: ubuntu-latest

    steps:
      # 1. AdÄ±m: Kodu GitHub Actions makinesine indir
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. AdÄ±m: Node.js kurulumu
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ==========================================
      # BOT BUILD
      # ==========================================
      - name: ğŸ¤– Temiz node_modules (Bot)
        run: |
          rm -rf node_modules
          echo "Bot node_modules klasÃ¶rÃ¼ silindi."

      - name: ğŸ¤– Install dependencies (Bot)
        run: npm ci --omit=dev

      - name: ğŸ“¦ Archive Bot
        run: |
          tar --exclude='frontend' --exclude='backend' --exclude='.git' --exclude='node_modules' -czvf bot.tar.gz . || {
            code=$?
            echo "UyarÄ±: tar arÅŸivleme sÄ±rasÄ±nda dosya deÄŸiÅŸti (kod: $code), bu genellikle Ã¶nemsizdir.";
            exit 0;
          }

      # ==========================================
      # FRONTEND BUILD  
      # ==========================================
      - name: ğŸŒ Temiz node_modules (Frontend)
        run: |
          cd frontend
          rm -rf node_modules .next
          echo "Frontend node_modules ve .next klasÃ¶rleri silindi."
          cd ..

      - name: ğŸŒ Install dependencies (Frontend)
        run: |
          cd frontend
          npm ci
          cd ..

      - name: ğŸŒ Build Frontend
        env:
          NEXT_PUBLIC_API_URL: https://neuroviabot.xyz
          NEXT_PUBLIC_BOT_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
          NODE_ENV: production
        run: |
          cd frontend
          npm run build
          cd ..

      - name: ğŸ“¦ Archive Frontend
        run: |
          tar --exclude='node_modules' --exclude='.next/cache' -czvf frontend.tar.gz -C frontend . || {
            code=$?
            echo "UyarÄ±: tar arÅŸivleme sÄ±rasÄ±nda dosya deÄŸiÅŸti (kod: $code), bu genellikle Ã¶nemsizdir.";
            exit 0;
          }

      # ==========================================
      # BACKEND BUILD
      # ==========================================
      - name: âš™ï¸ Temiz node_modules (Backend)
        run: |
          cd backend
          rm -rf node_modules
          echo "Backend node_modules klasÃ¶rÃ¼ silindi."
          cd ..

      - name: âš™ï¸ Install dependencies (Backend)
        run: |
          cd backend
          npm ci --omit=dev
          cd ..

      - name: ğŸ“¦ Archive Backend
        run: tar --exclude='node_modules' -czvf backend.tar.gz -C backend .

      # ==========================================
      # UPLOAD TO VPS
      # ==========================================
      - name: ğŸš€ Copy archives to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "bot.tar.gz,frontend.tar.gz,backend.tar.gz"
          target: "/root"
          strip_components: 0

      # ==========================================
      # DEPLOY ON VPS
      # ==========================================
      - name: ğŸ¯ Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            # Ana dizini oluÅŸtur
            mkdir -p /root/neuroviabot/bot
            
            # Eski dosyalarÄ± backup al
            if [ -d "/root/neuroviabot/bot" ]; then
              echo "ğŸ“¦ Mevcut dosyalar backup alÄ±nÄ±yor..."
              cp -r /root/neuroviabot/bot /root/neuroviabot/bot-backup-$(date +%Y%m%d-%H%M%S) || true
            fi

            # Bot arÅŸivini Ã§Ä±kar
            echo "ğŸ¤– Bot deploy ediliyor..."
            tar -xzvf /root/bot.tar.gz -C /root/neuroviabot/bot

            # Frontend dizini oluÅŸtur ve arÅŸivi Ã§Ä±kar
            echo "ğŸŒ Frontend deploy ediliyor..."
            mkdir -p /root/neuroviabot/bot/frontend
            tar -xzvf /root/frontend.tar.gz -C /root/neuroviabot/bot/frontend

            # Backend dizini oluÅŸtur ve arÅŸivi Ã§Ä±kar
            echo "âš™ï¸ Backend deploy ediliyor..."
            mkdir -p /root/neuroviabot/bot/backend
            tar -xzvf /root/backend.tar.gz -C /root/neuroviabot/bot/backend

            # Bot baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kur
            echo "ğŸ“¦ Bot baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            cd /root/neuroviabot/bot
            npm ci --omit=dev

            # Frontend baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kur
            echo "ğŸ“¦ Frontend production baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            cd /root/neuroviabot/bot/frontend
            npm ci --omit=dev

            # Backend baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kur
            echo "ğŸ“¦ Backend production baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            cd /root/neuroviabot/bot/backend
            npm ci --omit=dev

            # PM2 ile servisleri yeniden baÅŸlat
            echo "ğŸ”„ PM2 servisleri yeniden baÅŸlatÄ±lÄ±yor..."
            
            # Bot servisi
            echo "ğŸ¤– Bot servisi baÅŸlatÄ±lÄ±yor..."
            pm2 stop neuroviabot || true
            pm2 delete neuroviabot || true
            cd /root/neuroviabot/bot
            pm2 start index.js --name "neuroviabot"
            
            # Frontend servisi (Next.js)
            echo "ğŸŒ Frontend servisi baÅŸlatÄ±lÄ±yor..."
            pm2 stop neuroviabot-frontend || true
            pm2 delete neuroviabot-frontend || true
            cd /root/neuroviabot/bot/frontend
            pm2 start npm --name "neuroviabot-frontend" -- start
            
            # Backend servisi (Express.js)
            echo "âš™ï¸ Backend servisi baÅŸlatÄ±lÄ±yor..."
            pm2 stop neuroviabot-backend || true
            pm2 delete neuroviabot-backend || true
            cd /root/neuroviabot/bot/backend
            pm2 start npm --name "neuroviabot-backend" -- start

            # Servisleri kaydet
            pm2 save
            pm2 status

            # Health check
            echo "ğŸ¥ Sistem durumu kontrol ediliyor..."
            sleep 5
            
            # Frontend health check (Next.js Port 3001)
            echo "ğŸ” Frontend health check..."
            curl -I http://localhost:3001 && echo "âœ… Frontend eriÅŸilebilir" || echo "âŒ Frontend eriÅŸilemiyor"
            
            # Backend health check (Express.js Port 5000)
            echo "ğŸ” Backend health check..."
            curl -I http://localhost:5000/api/health || curl -I http://localhost:5000 && echo "âœ… Backend eriÅŸilebilir" || echo "âŒ Backend eriÅŸilemiyor"
            
            # Caddy proxy health check
            echo "ğŸ” Caddy proxy health check..."
            curl -I http://localhost:80 && echo "âœ… Caddy proxy Ã§alÄ±ÅŸÄ±yor" || echo "âŒ Caddy proxy Ã§alÄ±ÅŸmÄ±yor"

            # Cleanup temp files
            rm -f /root/bot.tar.gz /root/frontend.tar.gz /root/backend.tar.gz

            echo "ğŸ‰ NeuroViaBot deploy tamamlandÄ±!"

      # ==========================================
      # CLEANUP
      # ==========================================
      - name: ğŸ§¹ Cleanup
        run: rm -f bot.tar.gz frontend.tar.gz backend.tar.gz